{
    "sourceFile": "backend/src/controllers/aiMaintenanceController.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 4,
            "patches": [
                {
                    "date": 1764590557684,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1764590721113,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,65 +1,71 @@\n-// src/controllers/aiMaintenanceController.ts\r\n+import axios from \"axios\";\r\n import { Request, Response } from \"express\";\r\n-import OpenAI from \"openai\";\r\n \r\n-const openai = new OpenAI({\r\n-  apiKey: process.env.OPENAI_API_KEY!,\r\n-});\r\n-\r\n-export const estimateMaintenanceCost = async (req: Request, res: Response) => {\r\n+export const estimateMaintenance = async (req: Request, res: Response) => {\r\n   try {\r\n-    const {\r\n-      brand,\r\n-      model,\r\n-      year,\r\n-      mileage,\r\n-      price,\r\n-      condition,\r\n-      fuelType,\r\n-      transmission,\r\n-    } = req.body;\r\n+    const OPENROUTER_API_KEY = process.env.OPENROUTER_API_KEY;\r\n+    const MODEL = process.env.OPENROUTER_MODEL || \"mistralai/mistral-7b-instruct\";\r\n \r\n-    const prompt = `\r\n-You are an expert car mechanic and cost analyst.\r\n+    if (!OPENROUTER_API_KEY) {\r\n+      return res.status(500).json({ message: \"Missing OPENROUTER_API_KEY\" });\r\n+    }\r\n \r\n-Estimate the YEARLY maintenance cost for the following used car:\r\n+    const car = req.body;\r\n \r\n-Brand: ${brand}\r\n-Model: ${model}\r\n-Year: ${year}\r\n-Mileage: ${mileage}\r\n-Price: ${price}\r\n-Condition: ${condition}\r\n-Fuel Type: ${fuelType || \"unknown\"}\r\n-Transmission: ${transmission || \"unknown\"}\r\n+    const prompt = `\r\n+You are an expert car mechanic AI.\r\n+Estimate the yearly maintenance cost for this car:\r\n \r\n-Return ONLY valid JSON in this exact format:\r\n+Brand: ${car.brand}\r\n+Model: ${car.model}\r\n+Year: ${car.year}\r\n+Mileage: ${car.mileage}\r\n+Condition: ${car.condition}\r\n+Fuel Type: ${car.fuelType}\r\n+Transmission: ${car.transmission}\r\n \r\n+Return JSON with:\r\n {\r\n   \"yearlyLow\": number,\r\n   \"yearlyHigh\": number,\r\n   \"recommendedYearlyBudget\": number,\r\n   \"riskLevel\": \"low\" | \"medium\" | \"high\",\r\n-  \"summary\": \"short overview string\",\r\n-  \"commonRepairs\": [\"string\", \"string\"],\r\n-  \"tips\": \"string with practical advice\"\r\n+  \"commonRepairs\": string[],\r\n+  \"summary\": string,\r\n+  \"tips\": string\r\n }\r\n `;\r\n \r\n-    const completion = await openai.chat.completions.create({\r\n-      model: \"gpt-4o-mini\",\r\n-      messages: [{ role: \"user\", content: prompt }],\r\n-      response_format: { type: \"json_object\" },\r\n-    });\r\n+    const response = await axios.post(\r\n+      \"https://openrouter.ai/api/v1/chat/completions\",\r\n+      {\r\n+        model: MODEL,\r\n+        messages: [{ role: \"user\", content: prompt }],\r\n+        temperature: 0.7,\r\n+      },\r\n+      {\r\n+        headers: {\r\n+          Authorization: `Bearer ${OPENROUTER_API_KEY}`,\r\n+          \"Content-Type\": \"application/json\",\r\n+        },\r\n+      }\r\n+    );\r\n \r\n-    const content = completion.choices[0].message.content ?? \"{}\";\r\n-    const data = JSON.parse(content);\r\n+    const content = response.data.choices[0].message.content;\r\n \r\n-    return res.json(data);\r\n+    let jsonData;\r\n+    try {\r\n+      jsonData = JSON.parse(content);\r\n+    } catch (error) {\r\n+      return res.status(500).json({\r\n+        message: \"AI returned invalid JSON\",\r\n+        raw: content,\r\n+      });\r\n+    }\r\n+\r\n+    res.json(jsonData);\r\n   } catch (error) {\r\n     console.error(\"AI Maintenance Error:\", error);\r\n-    return res\r\n-      .status(500)\r\n-      .json({ message: \"AI maintenance estimation failed.\" });\r\n+    res.status(500).json({ message: \"Maintenance AI failed\" });\r\n   }\r\n };\r\n"
                },
                {
                    "date": 1764591182818,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -52,18 +52,31 @@\n     );\r\n \r\n     const content = response.data.choices[0].message.content;\r\n \r\n-    let jsonData;\r\n-    try {\r\n-      jsonData = JSON.parse(content);\r\n-    } catch (error) {\r\n-      return res.status(500).json({\r\n-        message: \"AI returned invalid JSON\",\r\n-        raw: content,\r\n-      });\r\n-    }\r\n+   let cleaned = content.trim();\r\n \r\n+// Extract JSON between first { and last }\r\n+const jsonMatch = cleaned.match(/\\{[\\s\\S]*\\}/);\r\n+\r\n+if (!jsonMatch) {\r\n+  return res.status(500).json({\r\n+    message: \"AI returned invalid JSON format\",\r\n+    raw: content,\r\n+  });\r\n+}\r\n+\r\n+try {\r\n+  const jsonData = JSON.parse(jsonMatch[0]);\r\n+  return res.json(jsonData);\r\n+} catch (err) {\r\n+  return res.status(500).json({\r\n+    message: \"AI JSON parse error\",\r\n+    raw: content,\r\n+  });\r\n+}\r\n+\r\n+\r\n     res.json(jsonData);\r\n   } catch (error) {\r\n     console.error(\"AI Maintenance Error:\", error);\r\n     res.status(500).json({ message: \"Maintenance AI failed\" });\r\n"
                },
                {
                    "date": 1764591190013,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -52,31 +52,18 @@\n     );\r\n \r\n     const content = response.data.choices[0].message.content;\r\n \r\n-   let cleaned = content.trim();\r\n+    let jsonData;\r\n+    try {\r\n+      jsonData = JSON.parse(content);\r\n+    } catch (error) {\r\n+      return res.status(500).json({\r\n+        message: \"AI returned invalid JSON\",\r\n+        raw: content,\r\n+      });\r\n+    }\r\n \r\n-// Extract JSON between first { and last }\r\n-const jsonMatch = cleaned.match(/\\{[\\s\\S]*\\}/);\r\n-\r\n-if (!jsonMatch) {\r\n-  return res.status(500).json({\r\n-    message: \"AI returned invalid JSON format\",\r\n-    raw: content,\r\n-  });\r\n-}\r\n-\r\n-try {\r\n-  const jsonData = JSON.parse(jsonMatch[0]);\r\n-  return res.json(jsonData);\r\n-} catch (err) {\r\n-  return res.status(500).json({\r\n-    message: \"AI JSON parse error\",\r\n-    raw: content,\r\n-  });\r\n-}\r\n-\r\n-\r\n     res.json(jsonData);\r\n   } catch (error) {\r\n     console.error(\"AI Maintenance Error:\", error);\r\n     res.status(500).json({ message: \"Maintenance AI failed\" });\r\n"
                },
                {
                    "date": 1764591221895,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,4 +1,5 @@\n+// src/controllers/aiMaintenanceController.ts\r\n import axios from \"axios\";\r\n import { Request, Response } from \"express\";\r\n \r\n export const estimateMaintenance = async (req: Request, res: Response) => {\r\n@@ -11,11 +12,14 @@\n     }\r\n \r\n     const car = req.body;\r\n \r\n+    // -----------------------------\r\n+    // ðŸ”¥ AI Prompt\r\n+    // -----------------------------\r\n     const prompt = `\r\n-You are an expert car mechanic AI.\r\n-Estimate the yearly maintenance cost for this car:\r\n+You are an expert certified automotive mechanic AI.\r\n+Estimate the yearly maintenance cost for the following car:\r\n \r\n Brand: ${car.brand}\r\n Model: ${car.model}\r\n Year: ${car.year}\r\n@@ -23,9 +27,10 @@\n Condition: ${car.condition}\r\n Fuel Type: ${car.fuelType}\r\n Transmission: ${car.transmission}\r\n \r\n-Return JSON with:\r\n+Return ONLY valid JSON in this exact format:\r\n+\r\n {\r\n   \"yearlyLow\": number,\r\n   \"yearlyHigh\": number,\r\n   \"recommendedYearlyBudget\": number,\r\n@@ -33,10 +38,13 @@\n   \"commonRepairs\": string[],\r\n   \"summary\": string,\r\n   \"tips\": string\r\n }\r\n-`;\r\n+    `;\r\n \r\n+    // -----------------------------\r\n+    // ðŸ”¥ OpenRouter Request\r\n+    // -----------------------------\r\n     const response = await axios.post(\r\n       \"https://openrouter.ai/api/v1/chat/completions\",\r\n       {\r\n         model: MODEL,\r\n@@ -50,22 +58,52 @@\n         },\r\n       }\r\n     );\r\n \r\n-    const content = response.data.choices[0].message.content;\r\n+    const content = response.data.choices?.[0]?.message?.content;\r\n \r\n+    if (!content) {\r\n+      return res.status(500).json({\r\n+        message: \"AI returned empty response\",\r\n+        raw: response.data\r\n+      });\r\n+    }\r\n+\r\n+    // -----------------------------\r\n+    // ðŸ”¥ Extract clean JSON from messy AI output\r\n+    // -----------------------------\r\n+    const cleaned = content.trim();\r\n+\r\n+    // Extract the first {...} block\r\n+    const jsonMatch = cleaned.match(/\\{[\\s\\S]*\\}/);\r\n+\r\n+    if (!jsonMatch) {\r\n+      return res.status(500).json({\r\n+        message: \"AI returned invalid JSON format\",\r\n+        raw: cleaned,\r\n+      });\r\n+    }\r\n+\r\n+    // Parse the extracted JSON\r\n     let jsonData;\r\n     try {\r\n-      jsonData = JSON.parse(content);\r\n-    } catch (error) {\r\n+      jsonData = JSON.parse(jsonMatch[0]);\r\n+    } catch (err) {\r\n       return res.status(500).json({\r\n-        message: \"AI returned invalid JSON\",\r\n-        raw: content,\r\n+        message: \"AI JSON parse error\",\r\n+        raw: cleaned,\r\n       });\r\n     }\r\n \r\n-    res.json(jsonData);\r\n+    // -----------------------------\r\n+    // ðŸ”¥ Final Response\r\n+    // -----------------------------\r\n+    return res.json(jsonData);\r\n+\r\n   } catch (error) {\r\n     console.error(\"AI Maintenance Error:\", error);\r\n-    res.status(500).json({ message: \"Maintenance AI failed\" });\r\n+    return res.status(500).json({\r\n+      message: \"Maintenance AI failed\",\r\n+      error: (error as Error).message,\r\n+    });\r\n   }\r\n };\r\n"
                }
            ],
            "date": 1764590557684,
            "name": "Commit-0",
            "content": "// src/controllers/aiMaintenanceController.ts\r\nimport { Request, Response } from \"express\";\r\nimport OpenAI from \"openai\";\r\n\r\nconst openai = new OpenAI({\r\n  apiKey: process.env.OPENAI_API_KEY!,\r\n});\r\n\r\nexport const estimateMaintenanceCost = async (req: Request, res: Response) => {\r\n  try {\r\n    const {\r\n      brand,\r\n      model,\r\n      year,\r\n      mileage,\r\n      price,\r\n      condition,\r\n      fuelType,\r\n      transmission,\r\n    } = req.body;\r\n\r\n    const prompt = `\r\nYou are an expert car mechanic and cost analyst.\r\n\r\nEstimate the YEARLY maintenance cost for the following used car:\r\n\r\nBrand: ${brand}\r\nModel: ${model}\r\nYear: ${year}\r\nMileage: ${mileage}\r\nPrice: ${price}\r\nCondition: ${condition}\r\nFuel Type: ${fuelType || \"unknown\"}\r\nTransmission: ${transmission || \"unknown\"}\r\n\r\nReturn ONLY valid JSON in this exact format:\r\n\r\n{\r\n  \"yearlyLow\": number,\r\n  \"yearlyHigh\": number,\r\n  \"recommendedYearlyBudget\": number,\r\n  \"riskLevel\": \"low\" | \"medium\" | \"high\",\r\n  \"summary\": \"short overview string\",\r\n  \"commonRepairs\": [\"string\", \"string\"],\r\n  \"tips\": \"string with practical advice\"\r\n}\r\n`;\r\n\r\n    const completion = await openai.chat.completions.create({\r\n      model: \"gpt-4o-mini\",\r\n      messages: [{ role: \"user\", content: prompt }],\r\n      response_format: { type: \"json_object\" },\r\n    });\r\n\r\n    const content = completion.choices[0].message.content ?? \"{}\";\r\n    const data = JSON.parse(content);\r\n\r\n    return res.json(data);\r\n  } catch (error) {\r\n    console.error(\"AI Maintenance Error:\", error);\r\n    return res\r\n      .status(500)\r\n      .json({ message: \"AI maintenance estimation failed.\" });\r\n  }\r\n};\r\n"
        }
    ]
}