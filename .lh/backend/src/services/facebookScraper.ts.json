{
    "sourceFile": "backend/src/services/facebookScraper.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1763932765196,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763933592630,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,74 @@\n+import puppeteer from \"puppeteer\";\r\n+import * as cheerio from \"cheerio\";\r\n+\r\n+export interface FacebookScrapeResult {\r\n+  title: string;\r\n+  description: string;\r\n+  price: number | null;\r\n+  images: string[];\r\n+  location: string | null;\r\n+  externalId?: string;\r\n+}\r\n+\r\n+export const scrapeFacebookMarketplace = async (url: string): Promise<FacebookScrapeResult> => {\r\n+  const browser = await puppeteer.launch({\r\n+    headless: true\r\n+\r\n+    args: [\"--no-sandbox\", \"--disable-setuid-sandbox\"],\r\n+  });\r\n+\r\n+  try {\r\n+    const page = await browser.newPage();\r\n+    await page.setUserAgent(\r\n+      \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120 Safari/537.36\"\r\n+    );\r\n+\r\n+    await page.goto(url, { waitUntil: \"domcontentloaded\", timeout: 30000 });\r\n+\r\n+    const html = await page.content();\r\n+    const $ = cheerio.load(html);\r\n+\r\n+    const title =\r\n+      $(\"meta[property='og:title']\").attr(\"content\") ||\r\n+      $(\"title\").text().trim() ||\r\n+      \"Unknown\";\r\n+\r\n+    const description =\r\n+      $(\"meta[property='og:description']\").attr(\"content\")?.trim() || \"\";\r\n+\r\n+    // Price: try meta, then text fallback\r\n+    const priceMeta = $(\"meta[property='product:price:amount']\").attr(\"content\");\r\n+    let price: number | null = priceMeta ? Number(priceMeta) : null;\r\n+\r\n+    if (!price) {\r\n+      const priceText = html.match(/\\$[\\s]*([0-9,]+)/);\r\n+      price = priceText ? Number(priceText[1].replace(/,/g, \"\")) : null;\r\n+    }\r\n+\r\n+    const images: string[] = [];\r\n+    $(\"meta[property='og:image']\").each((_, el) => {\r\n+      const img = $(el).attr(\"content\");\r\n+      if (img) images.push(img);\r\n+    });\r\n+\r\n+    const externalIdMatch = url.match(/item\\/(\\d+)/);\r\n+    const externalId = externalIdMatch?.[1];\r\n+\r\n+    // Location is inconsistent in FB HTML\r\n+    const location =\r\n+      $(\"meta[property='place:location:latitude']\").length > 0\r\n+        ? \"Facebook Listing\"\r\n+        : null;\r\n+\r\n+    return {\r\n+      title,\r\n+      description,\r\n+      price,\r\n+      images: [...new Set(images)],\r\n+      location,\r\n+      externalId,\r\n+    };\r\n+  } finally {\r\n+    await browser.close();\r\n+  }\r\n+};\r\n"
                }
            ],
            "date": 1763932765196,
            "name": "Commit-0",
            "content": "import puppeteer from \"puppeteer\";\r\nimport * as cheerio from \"cheerio\";\r\n\r\nexport interface FacebookScrapeResult {\r\n  title: string;\r\n  description: string;\r\n  price: number | null;\r\n  images: string[];\r\n  location: string | null;\r\n  externalId?: string;\r\n}\r\n\r\nexport const scrapeFacebookMarketplace = async (url: string): Promise<FacebookScrapeResult> => {\r\n  const browser = await puppeteer.launch({\r\n    headless: \"new\",\r\n    args: [\"--no-sandbox\", \"--disable-setuid-sandbox\"],\r\n  });\r\n\r\n  try {\r\n    const page = await browser.newPage();\r\n    await page.setUserAgent(\r\n      \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120 Safari/537.36\"\r\n    );\r\n\r\n    await page.goto(url, { waitUntil: \"domcontentloaded\", timeout: 30000 });\r\n\r\n    const html = await page.content();\r\n    const $ = cheerio.load(html);\r\n\r\n    const title =\r\n      $(\"meta[property='og:title']\").attr(\"content\") ||\r\n      $(\"title\").text().trim() ||\r\n      \"Unknown\";\r\n\r\n    const description =\r\n      $(\"meta[property='og:description']\").attr(\"content\")?.trim() || \"\";\r\n\r\n    // Price: try meta, then text fallback\r\n    const priceMeta = $(\"meta[property='product:price:amount']\").attr(\"content\");\r\n    let price: number | null = priceMeta ? Number(priceMeta) : null;\r\n\r\n    if (!price) {\r\n      const priceText = html.match(/\\$[\\s]*([0-9,]+)/);\r\n      price = priceText ? Number(priceText[1].replace(/,/g, \"\")) : null;\r\n    }\r\n\r\n    const images: string[] = [];\r\n    $(\"meta[property='og:image']\").each((_, el) => {\r\n      const img = $(el).attr(\"content\");\r\n      if (img) images.push(img);\r\n    });\r\n\r\n    const externalIdMatch = url.match(/item\\/(\\d+)/);\r\n    const externalId = externalIdMatch?.[1];\r\n\r\n    // Location is inconsistent in FB HTML\r\n    const location =\r\n      $(\"meta[property='place:location:latitude']\").length > 0\r\n        ? \"Facebook Listing\"\r\n        : null;\r\n\r\n    return {\r\n      title,\r\n      description,\r\n      price,\r\n      images: [...new Set(images)],\r\n      location,\r\n      externalId,\r\n    };\r\n  } finally {\r\n    await browser.close();\r\n  }\r\n};\r\n"
        }
    ]
}