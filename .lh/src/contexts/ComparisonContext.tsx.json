{
    "sourceFile": "src/contexts/ComparisonContext.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 4,
            "patches": [
                {
                    "date": 1759427937294,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1764353852750,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,16 +1,24 @@\n-import React, { createContext, useContext, useState } from \"react\";\r\n+// src/contexts/ComparisonContext.tsx\r\n+import React, { createContext, useContext, useState, useEffect } from \"react\";\r\n import { Car } from \"@/types/car\";\r\n+import { useAuthStore } from \"@/stores/authStore\";\r\n+import { saveComparison } from \"@/services/carService\";\r\n \r\n+// Helper: validate MongoDB ObjectId\r\n+const isValidObjectId = (id: string) => /^[a-fA-F0-9]{24}$/.test(id);\r\n+\r\n interface ComparisonContextType {\r\n   comparisonList: Car[];\r\n   addToComparison: (car: Car) => boolean;\r\n   removeFromComparison: (carId: string) => void;\r\n   clearComparison: () => void;\r\n   isInComparison: (carId: string) => boolean;\r\n }\r\n \r\n-const ComparisonContext = createContext<ComparisonContextType | undefined>(undefined);\r\n+const ComparisonContext = createContext<ComparisonContextType | undefined>(\r\n+  undefined\r\n+);\r\n \r\n export const useComparison = () => {\r\n   const context = useContext(ComparisonContext);\r\n   if (!context) {\r\n@@ -20,34 +28,76 @@\n };\r\n \r\n const MAX_COMPARISON = 3;\r\n \r\n-export const ComparisonProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\r\n+export const ComparisonProvider: React.FC<{ children: React.ReactNode }> = ({\r\n+  children,\r\n+}) => {\r\n   const [comparisonList, setComparisonList] = useState<Car[]>([]);\r\n+  const token = useAuthStore((state) => state.token);\r\n+  const [hasSaved, setHasSaved] = useState(false); // avoid double saving\r\n \r\n+  // -------------------------------------\r\n+  // ADD CAR TO COMPARISON (with validation)\r\n+  // -------------------------------------\r\n   const addToComparison = (car: Car): boolean => {\r\n-    if (comparisonList.length >= MAX_COMPARISON) {\r\n+    // Must be real DB car\r\n+    if (!isValidObjectId(car.id)) {\r\n+      console.warn(\"Skipping compare: ID is not a valid MongoDB ObjectId\", car.id);\r\n       return false;\r\n     }\r\n-    if (comparisonList.find((c) => c.id === car.id)) {\r\n-      return false;\r\n-    }\r\n+\r\n+    if (comparisonList.length >= MAX_COMPARISON) return false;\r\n+    if (comparisonList.some((c) => c.id === car.id)) return false;\r\n+\r\n     setComparisonList((prev) => [...prev, car]);\r\n     return true;\r\n   };\r\n \r\n+  // Remove by ID\r\n   const removeFromComparison = (carId: string) => {\r\n     setComparisonList((prev) => prev.filter((car) => car.id !== carId));\r\n   };\r\n \r\n+  // Clear all\r\n   const clearComparison = () => {\r\n     setComparisonList([]);\r\n+    setHasSaved(false);\r\n   };\r\n \r\n+  // Check if car in comparison\r\n   const isInComparison = (carId: string) => {\r\n     return comparisonList.some((car) => car.id === carId);\r\n   };\r\n \r\n+  // ------------------------------------------------------\r\n+  // AUTO-SAVE the first TWO REAL cars to DB (only once)\r\n+  // ------------------------------------------------------\r\n+  useEffect(() => {\r\n+    const doSave = async () => {\r\n+      if (!token) return;\r\n+      if (comparisonList.length < 2) return;\r\n+      if (hasSaved) return;\r\n+\r\n+      const [carA, carB] = comparisonList;\r\n+\r\n+      if (!isValidObjectId(carA.id) || !isValidObjectId(carB.id)) {\r\n+        console.warn(\"Not saving comparison: invalid IDs\", carA.id, carB.id);\r\n+        return;\r\n+      }\r\n+\r\n+      try {\r\n+        await saveComparison(carA.id, carB.id, token);\r\n+        console.log(\"Comparison saved to database!\");\r\n+        setHasSaved(true);\r\n+      } catch (err) {\r\n+        console.error(\"Error saving comparison:\", err);\r\n+      }\r\n+    };\r\n+\r\n+    doSave();\r\n+  }, [comparisonList, token, hasSaved]);\r\n+\r\n   return (\r\n     <ComparisonContext.Provider\r\n       value={{\r\n         comparisonList,\r\n"
                },
                {
                    "date": 1764355933714,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -39,21 +39,27 @@\n   // -------------------------------------\r\n   // ADD CAR TO COMPARISON (with validation)\r\n   // -------------------------------------\r\n   const addToComparison = (car: Car): boolean => {\r\n-    // Must be real DB car\r\n-    if (!isValidObjectId(car.id)) {\r\n-      console.warn(\"Skipping compare: ID is not a valid MongoDB ObjectId\", car.id);\r\n-      return false;\r\n-    }\r\n+  const mongoId = car.id || (car as any)._id;\r\n \r\n-    if (comparisonList.length >= MAX_COMPARISON) return false;\r\n-    if (comparisonList.some((c) => c.id === car.id)) return false;\r\n+  if (!isValidObjectId(mongoId)) {\r\n+    console.warn(\"Skipping compare: Invalid ID\", mongoId);\r\n+    return false;\r\n+  }\r\n \r\n-    setComparisonList((prev) => [...prev, car]);\r\n-    return true;\r\n-  };\r\n+  // Normalize object — backend MUST receive correct ids\r\n+  car.id = mongoId;\r\n+  (car as any)._id = mongoId;\r\n \r\n+  if (comparisonList.length >= MAX_COMPARISON) return false;\r\n+  if (comparisonList.some((c) => c.id === mongoId)) return false;\r\n+\r\n+  setComparisonList((prev) => [...prev, car]);\r\n+  return true;\r\n+};\r\n+\r\n+\r\n   // Remove by ID\r\n   const removeFromComparison = (carId: string) => {\r\n     setComparisonList((prev) => prev.filter((car) => car.id !== carId));\r\n   };\r\n"
                },
                {
                    "date": 1764356202177,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -38,19 +38,19 @@\n \r\n   // -------------------------------------\r\n   // ADD CAR TO COMPARISON (with validation)\r\n   // -------------------------------------\r\n-  const addToComparison = (car: Car): boolean => {\r\n-  const mongoId = car.id || (car as any)._id;\r\n+ const addToComparison = (car: Car): boolean => {\r\n+  const mongoId = car._id ?? car.id; // use _id if available\r\n \r\n   if (!isValidObjectId(mongoId)) {\r\n     console.warn(\"Skipping compare: Invalid ID\", mongoId);\r\n     return false;\r\n   }\r\n \r\n-  // Normalize object — backend MUST receive correct ids\r\n+  // Normalize object — backend expects _id\r\n   car.id = mongoId;\r\n-  (car as any)._id = mongoId;\r\n+  car._id = mongoId;\r\n \r\n   if (comparisonList.length >= MAX_COMPARISON) return false;\r\n   if (comparisonList.some((c) => c.id === mongoId)) return false;\r\n \r\n@@ -58,8 +58,9 @@\n   return true;\r\n };\r\n \r\n \r\n+\r\n   // Remove by ID\r\n   const removeFromComparison = (carId: string) => {\r\n     setComparisonList((prev) => prev.filter((car) => car.id !== carId));\r\n   };\r\n"
                },
                {
                    "date": 1764356209593,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -39,18 +39,18 @@\n   // -------------------------------------\r\n   // ADD CAR TO COMPARISON (with validation)\r\n   // -------------------------------------\r\n  const addToComparison = (car: Car): boolean => {\r\n-  const mongoId = car._id ?? car.id; // use _id if available\r\n+  const mongoId = car.id ?? car.id; // use _id if available\r\n \r\n   if (!isValidObjectId(mongoId)) {\r\n     console.warn(\"Skipping compare: Invalid ID\", mongoId);\r\n     return false;\r\n   }\r\n \r\n   // Normalize object — backend expects _id\r\n   car.id = mongoId;\r\n-  car._id = mongoId;\r\n+  car.id = mongoId;\r\n \r\n   if (comparisonList.length >= MAX_COMPARISON) return false;\r\n   if (comparisonList.some((c) => c.id === mongoId)) return false;\r\n \r\n"
                }
            ],
            "date": 1759427937294,
            "name": "Commit-0",
            "content": "import React, { createContext, useContext, useState } from \"react\";\r\nimport { Car } from \"@/types/car\";\r\n\r\ninterface ComparisonContextType {\r\n  comparisonList: Car[];\r\n  addToComparison: (car: Car) => boolean;\r\n  removeFromComparison: (carId: string) => void;\r\n  clearComparison: () => void;\r\n  isInComparison: (carId: string) => boolean;\r\n}\r\n\r\nconst ComparisonContext = createContext<ComparisonContextType | undefined>(undefined);\r\n\r\nexport const useComparison = () => {\r\n  const context = useContext(ComparisonContext);\r\n  if (!context) {\r\n    throw new Error(\"useComparison must be used within a ComparisonProvider\");\r\n  }\r\n  return context;\r\n};\r\n\r\nconst MAX_COMPARISON = 3;\r\n\r\nexport const ComparisonProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\r\n  const [comparisonList, setComparisonList] = useState<Car[]>([]);\r\n\r\n  const addToComparison = (car: Car): boolean => {\r\n    if (comparisonList.length >= MAX_COMPARISON) {\r\n      return false;\r\n    }\r\n    if (comparisonList.find((c) => c.id === car.id)) {\r\n      return false;\r\n    }\r\n    setComparisonList((prev) => [...prev, car]);\r\n    return true;\r\n  };\r\n\r\n  const removeFromComparison = (carId: string) => {\r\n    setComparisonList((prev) => prev.filter((car) => car.id !== carId));\r\n  };\r\n\r\n  const clearComparison = () => {\r\n    setComparisonList([]);\r\n  };\r\n\r\n  const isInComparison = (carId: string) => {\r\n    return comparisonList.some((car) => car.id === carId);\r\n  };\r\n\r\n  return (\r\n    <ComparisonContext.Provider\r\n      value={{\r\n        comparisonList,\r\n        addToComparison,\r\n        removeFromComparison,\r\n        clearComparison,\r\n        isInComparison,\r\n      }}\r\n    >\r\n      {children}\r\n    </ComparisonContext.Provider>\r\n  );\r\n};\r\n"
        }
    ]
}