{
    "sourceFile": "src/pages/EditCar.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1763930184581,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1763930184581,
            "name": "Commit-0",
            "content": "// src/pages/EditCar.tsx\r\nimport { useState, useEffect } from \"react\";\r\nimport { useParams, useNavigate } from \"react-router-dom\";\r\nimport { useAuth } from \"@/contexts/AuthContext\";\r\nimport { getCarById, updateCar } from \"@/api/cars\";\r\nimport { mapApiCarToCar } from \"@/utils/mapApiCarToCar\";\r\n\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Checkbox } from \"@/components/ui/checkbox\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { toast } from \"@/hooks/use-toast\";\r\nimport { Upload, ArrowLeft, X } from \"lucide-react\";\r\n\r\nconst platformsList = [\r\n  { id: \"edmunds\", name: \"Edmunds\" },\r\n  { id: \"olx\", name: \"OLX\" },\r\n  { id: \"facebook\", name: \"Facebook Marketplace\" },\r\n  { id: \"autotrader\", name: \"AutoTrader\" },\r\n  { id: \"cars\", name: \"Cars.com\" },\r\n];\r\n\r\nconst EditCar = () => {\r\n  const { id } = useParams();\r\n  const navigate = useNavigate();\r\n  const { user } = useAuth();\r\n\r\n  const [loading, setLoading] = useState(true);\r\n  const [isSubmitting, setIsSubmitting] = useState(false);\r\n\r\n  const [formData, setFormData] = useState({\r\n    brand: \"\",\r\n    model: \"\",\r\n    year: \"\",\r\n    mileage: \"\",\r\n    price: \"\",\r\n    condition: \"\",\r\n    description: \"\",\r\n    platforms: [] as string[],\r\n  });\r\n\r\n  const [existingImages, setExistingImages] = useState<string[]>([]);\r\n  const [newImages, setNewImages] = useState<File[]>([]);\r\n  const [previewImages, setPreviewImages] = useState<string[]>([]);\r\n\r\n  useEffect(() => {\r\n    if (!user) navigate(\"/auth?mode=login\");\r\n  }, [user]);\r\n\r\n  // Load car data\r\n  useEffect(() => {\r\n    const loadCar = async () => {\r\n      try {\r\n        if (!id) return;\r\n\r\n        const apiCar = await getCarById(id);\r\n        const car = mapApiCarToCar(apiCar);\r\n\r\n        // Ownership check\r\n        if (car.seller.id !== user?._id) {\r\n          toast({ title: \"Unauthorized\", description: \"This is not your car.\" });\r\n          return navigate(\"/\");\r\n        }\r\n\r\n        setFormData({\r\n          brand: car.brand,\r\n          model: car.model,\r\n          year: String(car.year),\r\n          mileage: String(car.mileage),\r\n          price: String(car.price),\r\n          condition: car.condition,\r\n          description: car.description,\r\n          platforms: car.platform.map((p) => p.name.toLowerCase()),\r\n        });\r\n\r\n        setExistingImages(car.images);\r\n      } catch (err) {\r\n        console.error(err);\r\n        toast({ title: \"Error loading car\", variant: \"destructive\" });\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    };\r\n    loadCar();\r\n  }, [id]);\r\n\r\n  const handleChange = (field: string, value: string) => {\r\n    setFormData((prev) => ({ ...prev, [field]: value }));\r\n  };\r\n\r\n  const togglePlatform = (id: string) => {\r\n    setFormData((prev) => ({\r\n      ...prev,\r\n      platforms: prev.platforms.includes(id)\r\n        ? prev.platforms.filter((p) => p !== id)\r\n        : [...prev.platforms, id],\r\n    }));\r\n  };\r\n\r\n  const handleImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const files = e.target.files;\r\n    if (!files) return;\r\n\r\n    const added = Array.from(files);\r\n    setNewImages((prev) => [...prev, ...added]);\r\n    const previews = added.map((f) => URL.createObjectURL(f));\r\n    setPreviewImages((prev) => [...prev, ...previews]);\r\n  };\r\n\r\n  const removeNewImage = (index: number) => {\r\n    setNewImages((prev) => prev.filter((_, i) => i !== index));\r\n    setPreviewImages((prev) => prev.filter((_, i) => i !== index));\r\n  };\r\n\r\n  const removeExistingImage = (index: number) => {\r\n    setExistingImages((prev) => prev.filter((_, i) => i !== index));\r\n  };\r\n\r\n  const handleSubmit = async () => {\r\n    setIsSubmitting(true);\r\n\r\n    try {\r\n      const fd = new FormData();\r\n      fd.append(\"brand\", formData.brand);\r\n      fd.append(\"model\", formData.model);\r\n      fd.append(\"year\", formData.year);\r\n      fd.append(\"mileage\", formData.mileage);\r\n      fd.append(\"price\", formData.price);\r\n      fd.append(\"condition\", formData.condition);\r\n      fd.append(\"description\", formData.description);\r\n\r\n      formData.platforms.forEach((p) => fd.append(\"platforms\", p));\r\n      existingImages.forEach((img) => fd.append(\"existingImages\", img));\r\n      newImages.forEach((file) => fd.append(\"images\", file));\r\n\r\n      await updateCar(id!, fd, user!.token);\r\n\r\n      toast({ title: \"Car updated successfully\" });\r\n      navigate(\"/profile\");\r\n    } catch (err) {\r\n      toast({\r\n        title: \"Update failed\",\r\n        description: err instanceof Error ? err.message : \"Unknown error\",\r\n        variant: \"destructive\",\r\n      });\r\n    }\r\n\r\n    setIsSubmitting(false);\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"container mx-auto py-12 text-center\">\r\n        <h2 className=\"text-2xl\">Loading car...</h2>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-background\">\r\n      <div className=\"container mx-auto px-4 py-8\">\r\n        <Button variant=\"ghost\" className=\"mb-6 gap-2\" onClick={() => navigate(-1)}>\r\n          <ArrowLeft className=\"h-4 w-4\" /> Back\r\n        </Button>\r\n\r\n        <div className=\"max-w-3xl mx-auto\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Edit Listing</CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-6\">\r\n\r\n              {/* Brand + Model */}\r\n              <div className=\"grid grid-cols-2 gap-4\">\r\n                <div>\r\n                  <Label>Brand</Label>\r\n                  <Input\r\n                    value={formData.brand}\r\n                    onChange={(e) => handleChange(\"brand\", e.target.value)}\r\n                  />\r\n                </div>\r\n                <div>\r\n                  <Label>Model</Label>\r\n                  <Input\r\n                    value={formData.model}\r\n                    onChange={(e) => handleChange(\"model\", e.target.value)}\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              {/* Year + Mileage */}\r\n              <div className=\"grid grid-cols-2 gap-4\">\r\n                <div>\r\n                  <Label>Year</Label>\r\n                  <Input\r\n                    type=\"number\"\r\n                    value={formData.year}\r\n                    onChange={(e) => handleChange(\"year\", e.target.value)}\r\n                  />\r\n                </div>\r\n                <div>\r\n                  <Label>Mileage (mi)</Label>\r\n                  <Input\r\n                    type=\"number\"\r\n                    value={formData.mileage}\r\n                    onChange={(e) => handleChange(\"mileage\", e.target.value)}\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              {/* Price */}\r\n              <div>\r\n                <Label>Price ($)</Label>\r\n                <Input\r\n                  type=\"number\"\r\n                  value={formData.price}\r\n                  onChange={(e) => handleChange(\"price\", e.target.value)}\r\n                />\r\n              </div>\r\n\r\n              {/* Condition */}\r\n              <div>\r\n                <Label>Condition</Label>\r\n                <select\r\n                  className=\"w-full rounded-md border p-2\"\r\n                  value={formData.condition}\r\n                  onChange={(e) => handleChange(\"condition\", e.target.value)}\r\n                >\r\n                  <option value=\"new\">New</option>\r\n                  <option value=\"used\">Used</option>\r\n                  <option value=\"certified\">Certified</option>\r\n                </select>\r\n              </div>\r\n\r\n              {/* Description */}\r\n              <div>\r\n                <Label>Description</Label>\r\n                <Textarea\r\n                  rows={4}\r\n                  value={formData.description}\r\n                  onChange={(e) => handleChange(\"description\", e.target.value)}\r\n                />\r\n              </div>\r\n\r\n              {/* Platforms */}\r\n              <div>\r\n                <Label>Platforms</Label>\r\n                <div className=\"border rounded-lg p-4 space-y-3\">\r\n                  {platformsList.map((p) => (\r\n                    <div className=\"flex items-center gap-2\" key={p.id}>\r\n                      <Checkbox\r\n                        checked={formData.platforms.includes(p.id)}\r\n                        onCheckedChange={() => togglePlatform(p.id)}\r\n                      />\r\n                      <span>{p.name}</span>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n\r\n              {/* Images */}\r\n              <div className=\"space-y-2\">\r\n                <Label>Existing Images</Label>\r\n\r\n                <div className=\"grid grid-cols-3 gap-3\">\r\n                  {existingImages.map((img, index) => (\r\n                    <div key={index} className=\"relative group\">\r\n                      <img\r\n                        src={img}\r\n                        className=\"h-24 w-full object-cover rounded-md\"\r\n                      />\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => removeExistingImage(index)}\r\n                        className=\"absolute -top-2 -right-2 bg-destructive text-white rounded-full h-6 w-6 opacity-0 group-hover:opacity-100\"\r\n                      >\r\n                        <X className=\"h-4 w-4\" />\r\n                      </button>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n\r\n                <Label>Add New Images</Label>\r\n\r\n                <label\r\n                  htmlFor=\"new-images\"\r\n                  className=\"cursor-pointer border-dashed border-2 rounded-lg p-6 flex items-center justify-center hover:bg-muted\"\r\n                >\r\n                  <Upload className=\"h-6 w-6 text-muted-foreground mr-2\" />\r\n                  Upload Images\r\n                </label>\r\n\r\n                <input\r\n                  id=\"new-images\"\r\n                  type=\"file\"\r\n                  multiple\r\n                  accept=\"image/*\"\r\n                  className=\"hidden\"\r\n                  onChange={handleImageUpload}\r\n                />\r\n\r\n                {previewImages.length > 0 && (\r\n                  <div className=\"grid grid-cols-3 gap-3\">\r\n                    {previewImages.map((img, index) => (\r\n                      <div key={index} className=\"relative group\">\r\n                        <img\r\n                          src={img}\r\n                          className=\"h-24 w-full object-cover rounded-md\"\r\n                        />\r\n                        <button\r\n                          onClick={() => removeNewImage(index)}\r\n                          className=\"absolute -top-2 -right-2 bg-destructive text-white rounded-full h-6 w-6 opacity-0 group-hover:opacity-100\"\r\n                        >\r\n                          <X className=\"h-4 w-4\" />\r\n                        </button>\r\n                      </div>\r\n                    ))}\r\n                  </div>\r\n                )}\r\n              </div>\r\n\r\n              {/* Buttons */}\r\n              <div className=\"flex gap-3\">\r\n                <Button\r\n                  variant=\"outline\"\r\n                  className=\"w-full\"\r\n                  onClick={() => navigate(\"/profile\")}\r\n                >\r\n                  Cancel\r\n                </Button>\r\n                <Button\r\n                  className=\"w-full\"\r\n                  onClick={handleSubmit}\r\n                  disabled={isSubmitting}\r\n                >\r\n                  {isSubmitting ? \"Saving...\" : \"Save Changes\"}\r\n                </Button>\r\n              </div>\r\n\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default EditCar;\r\n"
        }
    ]
}